= Update query
:experimental:
:tabs-sync-option:

An Update query is used to update data in a TypeDB database by matching existing data, deleting some of it,
and then inserting some other data instead.

This page assumes you've already followed instructions from the xref:manual::writing/delete.adoc[] page.
Here, you'll see how to update data in a database using Studio, Console, or one of the drivers.

== How to send an Update query

The easiest way to send an Update query is to use Studio or Console:

[tabs]
====
Studio::
+
--
Follow the xref:manual::studio.adoc#_prepare_a_query[Studio manual]
to connect to TypeDB and select a project folder.
Then use the steps below:

. Use a drop-down list in the top toolbar to select a database with the name `sample_db`.
. Switch to `data` session and `write` transaction types.
. Open a new tab and insert or type in an Update query, for example:
+
.TypeQL Update query
[,typeql]
----
match
$u isa user, has name "Bob", has email $e;
delete
$u has $e;
insert
$u has email "the-bob@vaticle.com";
----
. Run the query by clicking the btn:[Run query] button (image:home::studio-icons/run.png[run]).
. Commit the changes by clicking the btn:[Commit query] button (image:home::studio-icons/commit.png[Commit]).
--

Console::
+
--
. Open a session and transaction:
+
[,bash]
----
transaction sample_db schema write
----
. Send the Define query:
+
[,bash]
----
match
$u isa user, has name "Bob", has email $e;
delete
$u has $e;
insert
$u has email "the-bob@vaticle.com";
----
+
Push btn:[Enter] twice to send the query.
. Commit the changes:
+
[,bash]
----
commit
----
--
====

To send a Define query programmatically, use xref:drivers::overview.adoc[drivers]:

//#todo Check all the codes
[tabs]
====
Rust::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,rust]
----
let query = "match
$u isa user, has name 'Bob', has email $e;
delete
$u has $e;
insert
$u has email 'the-bob@vaticle.com';";
let databases = DatabaseManager::new(driver);
let db = databases.get("sample_db")?;
let session = Session::new(db, SessionType::Data)?;
let tx = session.transaction(TransactionType::Write)?;
tx.query().insert(&query)?;
tx.commit().resolve()?;
----
--

Python::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,python]
----
query = """
match
$u isa user, has name "Bob", has email $e;
delete
$u has $e;
insert
$u has email "the-bob@vaticle.com";
"""
with driver.session("sample_db", SessionType.DATA) as session:
    with session.transaction(TransactionType.WRITE) as transaction:
        transaction.query.insert("insert $u isa user, has name 'Alice', has email 'alice@vaticle.com';")
        transaction.commit()
----
--

Java::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,java]
----
try (TypeDBSession session = driver.session("sample_db", TypeDBSession.Type.DATA)) {
    try (TypeDBTransaction Transaction = session.transaction(TypeDBTransaction.Type.WRITE)) {
        Transaction.query().insert("insert $u isa user, has name 'Alice', has email 'alice@vaticle.com';");
        Transaction.commit();
    }
}
----
--

Node.js::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,js]
----
session = await driver.session("sample_db", SessionType.DATA);
transaction = await session.transaction(TransactionType.WRITE);
await transaction.query.insert("insert $u isa user, has name 'Alice', has email 'alice@vaticle.com';");
await transaction.commit();
----
--

C++::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,cpp]
----
TypeDB::Options options;
    {
        auto session = driver.session("sample_db", TypeDB::SessionType::DATA, options);
        auto tx = session.transaction(TypeDB::TransactionType::WRITE, options);
        (void) tx.query.define("insert $u isa user, has name 'Alice', has email 'alice@vaticle.com';", options);
        tx.commit();
    }
----
--
====

== Response interpretation

An Update query returns all concepts that got inserted into the database.

Both `delete` and `insert` clauses are executed once per every result
matched by the `match` clause of the same Update query.

The `delete` clause of an Update query is executed the same number of times as the `insert` clause,
but if the concept specified for deletion is no longer present in a database for any reason,
that would not produce an error.
The query will continue its execution without deleting the missing concept.

You can check the response of an Update query to see what was inserted.
The response is a Stream/Iterator with a ConceptMap object for every execution of the `insert` clause.
A ConceptMap object maps every variable from a query to a particular concept in a database.

Alternatively, you can estimate the number of inserts in an Update query with a `match` clause
by running a dedicated Fetch or Get query with the same `match` clause in the same transaction.
Read queries can be used in a `write` transaction, and `write` transactions are snapshoted,
preventing data changes committed in other transactions from influencing the results.

=== Check the response

Let's say we send the following Update query with a `match` clause:

.Update query example
[.typeql]
----
match
$u isa user, has name "Bob", has email $e;
delete
$u has $e;
insert
$u has email "the-bob@vaticle.com";
----

The easiest way to check the response for the query is to use a TypeDB client: Studio or Console.

.Update query response example
[tabs]
====
Studio::
+
--
See the Log tab output at the bottom:

.Log output
[,typeql]
----
## Result> Update query successfully updated things in the databases:
{
    $u iid 0x826e80018000000000000001 isa user;
    $e bob@vaticle.com isa email;
    $_0 the-bob@vaticle.com isa email;
}
## Completed
----
--

Console::
+
--
See the terminal output:

.CLI output
[,typeql]
----
{
    $e the-bob@vaticle.com isa email;
    $u iid 0x826e80018000000000000001 isa user;
    $_0 the-bob@vaticle.com isa email;
}

answers: 1, total duration: 23 ms
----
--
====

To process the response of an Update query programmatically,
we need to collect the response and iterate through it.
The number of iterations is equal to the number of the `insert` clause executions:

.Process Insert query response
[tabs]
====
Rust::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,rust]
----
let query = "match
$u isa user, has name 'Bob', has email $e;
delete
$u has $e;
insert
$u has email 'the-bob@vaticle.com';";
let databases = DatabaseManager::new(driver);
let db = databases.get("sample_db")?;
let session = Session::new(db, SessionType::Data)?;
let tx = session.transaction(TransactionType::Write)?;
tx.query().update(&query)?;
tx.commit().resolve()?;
----
--

Python::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,python]
----
query = """match
$u isa user, has name "Bob", has email $e;
delete
$u has $e;
insert
$u has email "the-bob@vaticle.com";"""

with driver.session("sample_db", SessionType.DATA) as session:
    with session.transaction(TransactionType.WRITE) as transaction:
        response = transaction.query.update(query)
        i = 0
        for concept in response:
            i += 1
        if i == 1:
            transaction.commit()
            print("Updated")
        else:
            print(f"Unexpected number of updates attempted: {i}")
            transaction.close()
----
--

Java::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,java]
----
String query = """
                match $alice isa user, has email 'alice@vaticle.com'; $bob isa user, has email 'bob@vaticle.com';
                insert $f (friend: $alice, friend: $bob) isa friendship;
                """;
try (TypeDBSession session = driver.session("sample_db", TypeDBSession.Type.DATA)) {
    try (TypeDBTransaction Transaction = session.transaction(TypeDBTransaction.Type.WRITE)) {
        Transaction.query().insert(query);
        Transaction.commit();
    }
}
----
--

Node.js::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,js]
----
const query =  `match $alice isa user, has email 'alice@vaticle.com'; $bob isa user, has email 'bob@vaticle.com';
                insert $f (friend: $alice, friend: $bob) isa friendship;
                `;
session = await driver.session("sample_db", SessionType.DATA);
transaction = await session.transaction(TransactionType.WRITE);
await transaction.query.insert(query);
await transaction.commit();
----
--

C++::
+
--
Follow the xref:manual::connecting/connection.adoc[connection guide]
to connect the `driver` to TypeDB Cloud or TypeDB Core, then:

[,cpp]
----
std::string query = "match $alice isa user, has email 'alice@vaticle.com'; $bob isa user, has email 'bob@vaticle.com';
                    insert $f (friend: $alice, friend: $bob) isa friendship;";
TypeDB::Options options;
    {
        auto session = driver.session("sample_db", TypeDB::SessionType::DATA, options);
        auto tx = session.transaction(TypeDB::TransactionType::WRITE, options);
        (void) tx.query.define(query, options);
        tx.commit();
    }
----
--
====

The example above checks the response of an Update query and commits the changes only if the number of
inserts is equal to one.
Otherwise, it closes the transaction without committing the changes.

=== Estimate the number of inserts with a read query

You can send any type of read query,
but the most direct approach is to send an aggregated Get query to count the number of matches.
The `match` clause should be exactly the same as in the Update query you are trying to estimate.

.Checking the number of matched results
[,typeql]
----
match
$u isa user, has name "Bob", has email $e;
get; count;
----

The response should be a single number.

== Learn more

[cols-2]
--
.More about an xref:typeql::data/update.adoc[]
[.clickable]
****
Learn more about Update queries in TypeQL: syntax, behaviour, and query examples.
****

.xref:manual::reading/overview.adoc[]
[.clickable]
****
Learn how to read data from a TypeDB database.
****

.xref:learn::7-writing-data/7-writing-data.adoc[Writing data curriculum]
[.clickable]
****
Check out the Writing data section of our TypeDB Learning course.
****
--
